#!/usr/bin/env node
import{Command as me}from"commander";import d from"chalk";import ce from"ora";import V from"chalk";import E from"fs-extra";import y from"path";import B from"fs-extra";var c={PACKAGE_JSON:"package.json",PROJECT_DIR:".project",GIT_DIR:".git",NODE_MODULES:"node_modules",PRE_SESSION_SCRIPT:".project/scripts/pre-session.sh",TASK_TEMPLATE:".project/_templates/v1/task-template.md",CURRENT_TASK:".project/current-task.md"},f={CLAUDE:"CLAUDE.md",GEMINI:"GEMINI.md",CHATGPT:"CHATGPT.md"},R=["backlog","completed","decisions","docs","ideas","reports","scripts","_templates"],g={CLAUDE_CODE:"claude-code",CLAUDE_AI:"claude-ai",GEMINI:"gemini",CHATGPT:"chatgpt"};var u=(e,t)=>!!(e?.dependencies?.[t]||e?.devDependencies?.[t]),C=e=>B.pathExistsSync(e),_=[{id:"astro",name:"Astro",template:"astro",check:e=>u(e,"astro")||C("astro.config.mjs")||C("astro.config.js")},{id:"nextjs",name:"Next.js",template:"nextjs",check:e=>u(e,"next")||C("next.config.js")},{id:"react-vite",name:"React (Vite)",template:"react",check:e=>u(e,"react")&&C("vite.config.js")},{id:"react-cra",name:"React (CRA)",template:"react",check:e=>u(e,"react")&&u(e,"react-scripts")},{id:"react",name:"React",template:"react",check:e=>u(e,"react")},{id:"vue",name:"Vue",template:"vue",check:e=>u(e,"vue")},{id:"svelte",name:"Svelte",template:"svelte",check:e=>u(e,"svelte")}],M={"pnpm-lock.yaml":"pnpm","yarn.lock":"yarn","package-lock.json":"npm","bun.lockb":"bun"},U=[f.CLAUDE,f.GEMINI,f.CHATGPT];import k from"chalk";var T=class{isVerbose=!1;setVerbose(t){this.isVerbose=t}info(t){console.log(k.blue("\u2139"),t)}success(t){console.log(k.green("\u2714"),t)}warn(t){console.warn(k.yellow("\u26A0"),t)}error(t){let r=t instanceof Error?t.message:t;console.error(k.red("\u2716"),r)}debug(t,r){this.isVerbose&&(console.log(k.gray("\u{1F41B}"),t),r&&console.log(k.gray(JSON.stringify(r,null,2))))}},i=new T;async function F(e=process.cwd()){i.debug(`Detecting project in: ${e}`);let t=y.join(e,c.PACKAGE_JSON),r=await E.pathExists(t)?await E.readJson(t):null,[o,n,l,h]=await Promise.all([E.pathExists(y.join(e,c.GIT_DIR)),E.pathExists(y.join(e,c.NODE_MODULES)),E.pathExists(y.join(e,c.PROJECT_DIR)),Z(e,U)]),{framework:w,frameworkVersion:v}=Q(r);return{framework:w,frameworkVersion:v,packageManager:await X(e),hasGit:o,hasNodeModules:n,existingSetup:{hasProject:l,hasPrompts:h}}}function Q(e){if(!e)return{framework:null,frameworkVersion:null};let t=_.find(o=>o.check(e));if(!t)return{framework:null,frameworkVersion:null};let r=L(e,t.id)||L(e,t.id.split("-")[0]);return{framework:t.id,frameworkVersion:r}}async function X(e){for(let[t,r]of Object.entries(M))if(await E.pathExists(y.join(e,t)))return r;return null}var L=(e,t)=>e?.dependencies?.[t]||e?.devDependencies?.[t]||"";async function Z(e,t){let r=[];for(let o of t)await E.pathExists(y.join(e,o))&&r.push(o);return r}import p from"fs-extra";import m from"path";import G from"fs-extra";import ee from"path";async function $(e,t,r){if(!t||t.length===0)return e;i.debug(`Merging guidelines: ${t.join(", ")}`);let o=[];for(let h of t){let w=ee.join(r,`guidelines/${h}.md`);if(await G.pathExists(w)){let v=await G.readFile(w,"utf-8");o.push(v)}}if(o.length===0)return e;let n=o.join(`

---

`);return e.replace(/{{SLOT:guidelines}}[\s\S]*?{{\/SLOT:guidelines}}/,`{{SLOT:guidelines}}

${n}

{{/SLOT:guidelines}}`)}import{fileURLToPath as te}from"url";var re=te(import.meta.url),I=m.dirname(re);async function N(e,t){i.debug("Starting installation process");let r=m.join(I,"templates");if(p.existsSync(r)||(r=m.join(I,"../templates")),p.existsSync(r)||(r=m.join(process.cwd(),"src/templates")),!p.existsSync(r))throw i.error(`Templates directory not found in: ${r}`),new Error(`Templates directory not found. Searched in: ${m.join(I,"templates")} and ${m.join(I,"../templates")}`);i.debug(`Using templates from: ${r}`),await ie(r),i.debug("Generating prompt files..."),await Promise.all(e.ais.map(o=>oe(o,e,r))),i.debug("Making scripts executable..."),await se(),i.success("Installation completed successfully")}async function ie(e){i.debug("Creating project structure...");let t=m.join(e,"base/.project"),r=".project";try{await p.copy(t,r,{overwrite:!1,errorOnExist:!1})}catch(n){let l=n;throw l.code==="EACCES"?new Error(`Permission denied: Cannot write to ${r}`):l.code==="ENOSPC"?new Error("Disk full: Not enough space to install"):n}let o=m.join(process.cwd(),c.PROJECT_DIR);await p.ensureDir(o),await Promise.all(R.map(n=>p.ensureDir(m.join(o,n))))}async function oe(e,t,r){let o=m.join(r,"base/project-manager.md"),n=await p.readFile(o,"utf-8");t.guidelines&&t.guidelines.length>0&&(n=await $(n,t.guidelines,r));let l=ne(e);await p.writeFile(l,n,"utf-8")}function ne(e){return{"claude-code":"CLAUDE.md","claude-ai":"CLAUDE.md",gemini:"GEMINI.md",chatgpt:"CHATGPT.md"}[e]||`${e.toUpperCase()}.md`}async function se(){let e=[".project/scripts/pre-session.sh",".project/scripts/validate-dod.sh"];await Promise.all(e.map(async t=>{await p.pathExists(t)&&await p.chmod(t,"755")}))}import j from"inquirer";import b from"chalk";async function O(e,t={}){i.info(b.blue(`
\u{1F4CB} Installation Options
`));let{ais:r}=await j.prompt([{type:"checkbox",name:"ais",message:"Which AI tools will you use?",choices:[{name:"Claude Code (terminal AI assistant)",value:g.CLAUDE_CODE,checked:!0},{name:"Claude.ai (web interface)",value:g.CLAUDE_AI,checked:!0},{name:"Google Gemini",value:g.GEMINI,checked:!1},{name:"ChatGPT",value:g.CHATGPT,checked:!1}],validate:h=>h.length<1?"You must choose at least one AI tool.":!0}]),o=[{name:"React",value:"react",checked:e.framework?.includes("react")},{name:"Astro",value:"astro",checked:e.framework==="astro"},{name:"Next.js",value:"nextjs",checked:e.framework==="nextjs"},{name:"Vue",value:"vue",checked:e.framework==="vue"}],{guidelines:n}=await j.prompt([{type:"checkbox",name:"guidelines",message:"Add framework-specific guidelines?",choices:o}]),{version:l}=await j.prompt([{type:"list",name:"version",message:"Choose system version:",choices:[{name:"Compact (1,000 tokens, optimized) [RECOMMENDED]",value:"compact",short:"Compact"},{name:"Full (4,000 tokens, comprehensive)",value:"full",short:"Full"}],default:"compact"}]);if(!t.yes){i.info(b.blue(`
\u{1F4C4} Installation Summary
`)),i.info("Files to be created:"),i.info(b.gray("  \u2022 .project/ (directory structure)"));let h=l==="compact"?"~1,000":"~4,000";r.forEach(A=>{let Y=ae(A);i.info(b.gray(`  \u2022 ${Y} (${h} tokens${n.length>0?" + guidelines":""})`))});let w=e.existingSetup.hasPrompts;w.length>0&&(i.warn(`
 Warning: This will replace existing files:`),w.forEach(A=>i.warn(`   \u2022 ${A}`)));let{confirm:v}=await j.prompt([{type:"confirm",name:"confirm",message:"Proceed with installation?",default:!0}]);if(!v)return null}return{ais:r,guidelines:n,version:l,skipConfirmation:t.yes||!1}}function ae(e){return{[g.CLAUDE_CODE]:f.CLAUDE,[g.CLAUDE_AI]:f.CLAUDE,[g.GEMINI]:f.GEMINI,[g.CHATGPT]:f.CHATGPT}[e]||`${e.toUpperCase()}.md`}async function x(e={}){let t=ce("Detecting project...").start(),r=await F();t.succeed("Project detected"),r.framework&&i.info(`Found: ${r.framework} project`),r.hasGit&&i.info("Git repository: Yes"),r.packageManager&&i.info(`Package manager: ${r.packageManager}`);let o;if(e.preset?(i.warn("Preset feature coming soon, using interactive mode"),o=await O(r,e)):e.ai&&e.guidelines?o={ais:Array.isArray(e.ai)?e.ai:[e.ai],guidelines:Array.isArray(e.guidelines)?e.guidelines:[e.guidelines],version:e.full?"full":"compact",skipConfirmation:e.yes||!1}:o=await O(r,e),!o){i.error("Installation cancelled");return}t.start("Installing..."),await N(o,r),t.succeed("Installation complete!"),i.success("Installation complete!"),i.info("Next steps:"),i.info(`  1. Run: ${V.cyan(".project/scripts/pre-session.sh")}`),i.info(`  2. Create first task: ${V.cyan("cp .project/_templates/v1/task-template.md .project/current-task.md")}`),i.info("  3. Start coding with AI!"),(o.ais.includes("claude-code")||o.ais.includes("claude-ai"))&&(i.info("Start your AI session with:"),i.info(' "Follow session start protocol and continue development"'))}async function J(e={}){i.info("Updating AIPM..."),await x({...e,yes:e.yes||e.force}),i.success("Update completed")}async function H(){await Promise.resolve(),i.info("Running diff..."),i.warn("Diff functionality is experimental/stubbed.")}import K from"fs-extra";import z from"path";async function W(){i.info("Validating AIPM installation...");let e=[];await K.pathExists(z.join(process.cwd(),c.PROJECT_DIR))||e.push(`Missing ${c.PROJECT_DIR} directory`),await K.pathExists(z.join(process.cwd(),c.PRE_SESSION_SCRIPT))||e.push("Missing pre-session script"),e.length>0&&(i.error("Validation failed:"),e.forEach(t=>i.error(`- ${t}`)),process.exit(1)),i.success("Validation passed")}var D={name:"@rmarsigli/aipm",publishConfig:{access:"public"},type:"module",version:"1.0.1-beta.1",description:"Markdown-based project management system optimized for AI-assisted development",homepage:"https://github.com/rmarsigli/aipm",bugs:{url:"https://github.com/rmarsigli/aipm/issues"},repository:{type:"git",url:"git+https://github.com/rmarsigli/aipm.git"},license:"MIT",author:"Rafhael Marsigli <oi@rafhael.com.br>",main:"dist/cli.js",bin:{aipm:"./dist/cli.js"},scripts:{dev:"tsup --watch",build:"tsup","type-check":"tsc --noEmit",test:"NODE_OPTIONS=--experimental-vm-modules jest",lint:"eslint src/**/*.ts","lint:fix":"eslint src/**/*.ts --fix",format:'prettier --write "src/**/*.ts"',prepare:"husky"},"lint-staged":{"src/**/*.ts":["eslint --fix","prettier --write"]},dependencies:{chalk:"^5.6.2",commander:"^14.0.2",diff:"^8.0.2","fs-extra":"^11.3.3",inquirer:"^13.1.0",ora:"^9.0.0"},devDependencies:{"@eslint/js":"^9.39.2","@jest/globals":"^30.2.0","@types/fs-extra":"^11.0.4","@types/inquirer":"^9.0.9","@types/jest":"^30.0.0","@types/node":"^25.0.3","@typescript-eslint/eslint-plugin":"^8.52.0","@typescript-eslint/parser":"^8.52.0",eslint:"^9.39.2","eslint-config-prettier":"^10.1.8","eslint-plugin-prettier":"^5.5.4",globals:"^17.0.0",husky:"^9.1.7",jest:"^30.2.0","lint-staged":"^16.2.7",prettier:"^3.7.4","ts-jest":"^29.4.6",tsup:"^8.5.1",typescript:"^5.9.3","typescript-eslint":"^8.52.0"},pnpm:{overrides:{"test-exclude":"^7.0.1"}}};var S=D.version,dt=D.name;var P=new me,q=`
 \u2588\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2557\u2588\u2588\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2588\u2557   \u2588\u2588\u2588\u2557
\u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557\u2588\u2588\u2551\u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2588\u2588\u2551
\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2551\u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2588\u2588\u2554\u255D\u2588\u2588\u2554\u2588\u2588\u2588\u2588\u2554\u2588\u2588\u2551
\u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2551\u2588\u2588\u2551\u2588\u2588\u2554\u2550\u2550\u2550\u255D \u2588\u2588\u2551\u255A\u2588\u2588\u2554\u255D\u2588\u2588\u2551
\u2588\u2588\u2551  \u2588\u2588\u2551\u2588\u2588\u2551\u2588\u2588\u2551     \u2588\u2588\u2551 \u255A\u2550\u255D \u2588\u2588\u2551
\u255A\u2550\u255D  \u255A\u2550\u255D\u255A\u2550\u255D\u255A\u2550\u255D     \u255A\u2550\u255D     \u255A\u2550\u255D
`;P.name("aipm").description("AI-optimized project management system").version(S).option("-v, --verbose","Enable verbose logging").hook("preAction",e=>{e.opts().verbose&&(i.setVerbose(!0),i.debug("Verbose mode enabled"))});P.command("install").description("Install AIPM in current directory").option("-y, --yes","Skip confirmation prompts").option("-p, --preset <name>","Use preset configuration").option("--ai <ais...>","AI tools to use (claude-code, gemini, chatgpt)").option("--guidelines <frameworks...>","Framework guidelines (react, astro)").option("--compact","Use compact version (default)",!0).option("--full","Use full version").action(async e=>{console.log(d.blue(q)),console.log(d.blue(`AIPM v${S}
`));try{await x(e)}catch(t){let r=t instanceof Error?t.message:String(t);console.error(d.red(`
\u274C Error: ${r}
`)),process.exit(1)}});P.command("update").description("Update existing installation").option("-f, --force","Overwrite customizations").action(async e=>{console.log(d.blue(q)),console.log(d.blue(`AIPM v${S}
`));try{await J(e)}catch(t){let r=t instanceof Error?t.message:String(t);console.error(d.red(`
\u274C Error: ${r}
`)),process.exit(1)}});P.command("diff").description("Show what would change with update").action(async()=>{try{await H()}catch(e){let t=e instanceof Error?e.message:String(e);console.error(d.red(`
\u274C Error: ${t}
`)),process.exit(1)}});P.command("validate").description("Validate current installation").action(async()=>{try{await W()}catch(e){let t=e instanceof Error?e.message:String(e);console.error(d.red(`
\u274C Error: ${t}
`)),process.exit(1)}});P.parse(process.argv);process.argv.slice(2).length||P.outputHelp();
