#!/usr/bin/env node
"use strict";var B=Object.create;var $=Object.defineProperty;var Q=Object.getOwnPropertyDescriptor;var X=Object.getOwnPropertyNames;var Z=Object.getPrototypeOf,ee=Object.prototype.hasOwnProperty;var te=(e,t,o,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of X(t))!ee.call(e,r)&&r!==o&&$(e,r,{get:()=>t[r],enumerable:!(i=Q(t,r))||i.enumerable});return e};var n=(e,t,o)=>(o=e!=null?B(Z(e)):{},te(t||!e||!e.__esModule?$(o,"default",{value:e,enumerable:!0}):o,e));var q=require("commander"),p=n(require("chalk"));var H=n(require("ora")),s=n(require("chalk"));var g=n(require("fs-extra")),h=n(require("path"));var R=n(require("fs-extra")),d=(e,t)=>e?.dependencies?.[t]||e?.devDependencies?.[t],x=e=>R.default.pathExistsSync(e),T=[{id:"astro",name:"Astro",template:"astro",check:e=>d(e,"astro")||x("astro.config.mjs")||x("astro.config.js")},{id:"nextjs",name:"Next.js",template:"nextjs",check:e=>d(e,"next")||x("next.config.js")},{id:"react-vite",name:"React (Vite)",template:"react",check:e=>d(e,"react")&&x("vite.config.js")},{id:"react-cra",name:"React (CRA)",template:"react",check:e=>d(e,"react")&&d(e,"react-scripts")},{id:"react",name:"React",template:"react",check:e=>d(e,"react")},{id:"vue",name:"Vue",template:"vue",check:e=>d(e,"vue")},{id:"svelte",name:"Svelte",template:"svelte",check:e=>d(e,"svelte")}],G={"pnpm-lock.yaml":"pnpm","yarn.lock":"yarn","package-lock.json":"npm","bun.lockb":"bun"},L=["CLAUDE.md","GEMINI.md","CHATGPT.md"];async function U(e=process.cwd()){let t=h.default.join(e,"package.json"),o=await g.default.pathExists(t)?await g.default.readJson(t):null,[i,r,a,f]=await Promise.all([g.default.pathExists(h.default.join(e,".git")),g.default.pathExists(h.default.join(e,"node_modules")),g.default.pathExists(h.default.join(e,".project")),re(e,L)]),{framework:u,frameworkVersion:k}=oe(o);return{framework:u,frameworkVersion:k,packageManager:await ie(e),hasGit:i,hasNodeModules:r,existingSetup:{hasProject:a,hasPrompts:f}}}function oe(e){if(!e)return{framework:null,frameworkVersion:null};let t=T.find(i=>i.check(e));if(!t)return{framework:null,frameworkVersion:null};let o=O(e,t.id)||O(e,t.id.split("-")[0]);return{framework:t.id,frameworkVersion:o}}async function ie(e){for(let[t,o]of Object.entries(G))if(await g.default.pathExists(h.default.join(e,t)))return o;return null}var O=(e,t)=>e?.dependencies?.[t]||e?.devDependencies?.[t];async function re(e,t){let o=[];for(let i of t)await g.default.pathExists(h.default.join(e,i))&&o.push(i);return o}var l=n(require("fs-extra")),m=n(require("path"));var b=n(require("fs-extra")),_=n(require("path"));async function N(e,t,o){let i=[];for(let f of t){let u=_.default.join(o,`guidelines/${f}.md`);if(await b.default.pathExists(u)){let k=await b.default.readFile(u,"utf-8");i.push(k)}}if(i.length===0)return e;let r=i.join(`

---

`);return e.replace(/{{SLOT:guidelines}}[\s\S]*?{{\/SLOT:guidelines}}/,`{{SLOT:guidelines}}

${r}

{{/SLOT:guidelines}}`)}async function V(e,t){let o=m.default.join(__dirname,"templates");if(l.default.existsSync(o)||(o=m.default.join(__dirname,"../templates")),l.default.existsSync(o)||(o=m.default.join(process.cwd(),"src/templates")),!l.default.existsSync(o))throw new Error(`Templates directory not found. Searched in: ${m.default.join(__dirname,"templates")} and ${m.default.join(__dirname,"../templates")}`);await ne(o);for(let i of e.ais)await se(i,e,o);await ce()}async function ne(e){let t=m.default.join(e,"base/.project"),o=".project";try{await l.default.copy(t,o,{overwrite:!1,errorOnExist:!1})}catch(r){let a=r;throw a.code==="EACCES"?new Error(`Permission denied: Cannot write to ${o}`):a.code==="ENOSPC"?new Error("Disk full: Not enough space to install"):r}let i=["backlog","completed","decisions","docs","ideas","reports"];for(let r of i)await l.default.ensureDir(m.default.join(o,r))}async function se(e,t,o){let i=m.default.join(o,"base/project-manager.md"),r=await l.default.readFile(i,"utf-8");t.guidelines&&t.guidelines.length>0&&(r=await N(r,t.guidelines,o));let a=ae(e);await l.default.writeFile(a,r,"utf-8")}function ae(e){return{"claude-code":"CLAUDE.md","claude-ai":"CLAUDE.md",gemini:"GEMINI.md",chatgpt:"CHATGPT.md"}[e]||`${e.toUpperCase()}.md`}async function ce(){let e=[".project/scripts/pre-session.sh",".project/scripts/validate-dod.sh"];for(let t of e)await l.default.pathExists(t)&&await l.default.chmod(t,"755")}var j=n(require("inquirer")),y=n(require("chalk"));async function I(e,t={}){console.log(y.default.blue(`
\u{1F4CB} Installation Options
`));let{ais:o}=await j.default.prompt([{type:"checkbox",name:"ais",message:"Which AI tools will you use?",choices:[{name:"Claude Code (terminal AI assistant)",value:"claude-code",checked:!0},{name:"Claude.ai (web interface)",value:"claude-ai",checked:!0},{name:"Google Gemini",value:"gemini",checked:!1},{name:"ChatGPT",value:"chatgpt",checked:!1}],validate:f=>f.length<1?"You must choose at least one AI tool.":!0}]),i=[{name:"React",value:"react",checked:e.framework?.includes("react")},{name:"Astro",value:"astro",checked:e.framework==="astro"},{name:"Next.js",value:"nextjs",checked:e.framework==="nextjs"},{name:"Vue",value:"vue",checked:e.framework==="vue"}],{guidelines:r}=await j.default.prompt([{type:"checkbox",name:"guidelines",message:"Add framework-specific guidelines?",choices:i}]),{version:a}=await j.default.prompt([{type:"list",name:"version",message:"Choose system version:",choices:[{name:"Compact (1,000 tokens, optimized) [RECOMMENDED]",value:"compact",short:"Compact"},{name:"Full (4,000 tokens, comprehensive)",value:"full",short:"Full"}],default:"compact"}]);if(!t.yes){console.log(y.default.blue(`
\u{1F4C4} Installation Summary
`)),console.log("Files to be created:"),console.log(y.default.gray("  \u2022 .project/ (directory structure)"));let f=a==="compact"?"~1,000":"~4,000";o.forEach(E=>{let J=le(E);console.log(y.default.gray(`  \u2022 ${J} (${f} tokens${r.length>0?" + guidelines":""})`))});let u=e.existingSetup.hasPrompts;u.length>0&&(console.log(y.default.yellow(`
\u26A0\uFE0F  Warning: This will replace existing files:`)),u.forEach(E=>console.log(y.default.yellow(`   \u2022 ${E}`))));let{confirm:k}=await j.default.prompt([{type:"confirm",name:"confirm",message:"Proceed with installation?",default:!0}]);if(!k)return null}return{ais:o,guidelines:r,version:a,skipConfirmation:t.yes||!1}}function le(e){return{"claude-code":"CLAUDE.md","claude-ai":"CLAUDE.md",gemini:"GEMINI.md",chatgpt:"CHATGPT.md"}[e]||`${e.toUpperCase()}.md`}async function P(e={}){try{let t=(0,H.default)("Detecting project...").start(),o=await U();t.succeed("Project detected"),o.framework&&console.log(s.default.gray(`   \u2705 Found: ${o.framework} project`)),o.hasGit&&console.log(s.default.gray("   \u2705 Git repository: Yes")),o.packageManager&&console.log(s.default.gray(`   \u2705 Package manager: ${o.packageManager}`));let i;if(e.preset?(console.log(s.default.yellow(`
  Preset feature coming soon, using interactive mode
`)),i=await I(o,e)):e.ai&&e.guidelines?i={ais:Array.isArray(e.ai)?e.ai:[e.ai],guidelines:Array.isArray(e.guidelines)?e.guidelines:[e.guidelines],version:e.full?"full":"compact",skipConfirmation:e.yes||!1}:i=await I(o,e),!i){console.log(s.default.red(`
\u274C Installation cancelled
`));return}t.start("Installing..."),await V(i,o),t.succeed("Installation complete!"),console.log(s.default.green(`
\u{1F389} Installation complete!
`)),console.log("Next steps:"),console.log(s.default.gray("  1. Run: .project/scripts/pre-session.sh")),console.log(s.default.gray("  2. Create first task: cp .project/_templates/v1/task-template.md .project/current-task.md")),console.log(s.default.gray(`  3. Start coding with AI!
`)),(i.ais.includes("claude-code")||i.ais.includes("claude-ai"))&&(console.log(s.default.blue("\u{1F4DA} Start your AI session with:")),console.log(s.default.blue(`   "Follow session start protocol and continue development"
`)))}catch(t){throw t}}var A=n(require("chalk"));async function z(e={}){console.log(A.default.blue("Updating AIPM...")),await P({...e,skipConfirmation:e.yes||e.force}),console.log(A.default.green(`
\u2705 Update completed`))}var F=n(require("chalk"));async function K(){let e=process.cwd(),t=["CLAUDE.md","GEMINI.md","CHATGPT.md"];console.log(F.default.blue("Running diff...")),console.log(F.default.yellow("Diff functionality is experimental."))}var v=n(require("chalk")),S=n(require("fs-extra")),D=n(require("path"));async function W(){console.log(v.default.blue("Validating AIPM installation..."));let e=[];await S.default.pathExists(D.default.join(process.cwd(),".project"))||e.push("Missing .project directory"),await S.default.pathExists(D.default.join(process.cwd(),".project/scripts/pre-session.sh"))||e.push("Missing pre-session script"),e.length>0&&(console.error(v.default.red("Validation failed:")),e.forEach(t=>console.error(v.default.red(`- ${t}`))),process.exit(1)),console.log(v.default.green("\u2705 Validation passed"))}var M={name:"@rmarsigli/aipm",publishConfig:{access:"public"},version:"1.0.1-beta.1",description:"Markdown-based project management system optimized for AI-assisted development",homepage:"https://github.com/rmarsigli/aipm",bugs:{url:"https://github.com/rmarsigli/aipm/issues"},repository:{type:"git",url:"git+https://github.com/rmarsigli/aipm.git"},license:"MIT",author:"Rafhael Marsigli <oi@rafhael.com.br>",main:"dist/cli.js",bin:{aipm:"./dist/cli.js"},scripts:{dev:"tsup --watch",build:"tsup","type-check":"tsc --noEmit",test:"jest",lint:"eslint src/**/*.ts","lint:fix":"eslint src/**/*.ts --fix",format:'prettier --write "src/**/*.ts"',prepare:"husky"},"lint-staged":{"src/**/*.ts":["eslint --fix","prettier --write"]},dependencies:{chalk:"^5.6.2",commander:"^14.0.2",diff:"^8.0.2","fs-extra":"^11.3.3",inquirer:"^13.1.0",ora:"^9.0.0"},devDependencies:{"@eslint/js":"^9.39.2","@types/diff":"^8.0.0","@types/fs-extra":"^11.0.4","@types/inquirer":"^9.0.9","@types/jest":"^30.0.0","@types/node":"^25.0.3","@typescript-eslint/eslint-plugin":"^8.52.0","@typescript-eslint/parser":"^8.52.0",eslint:"^9.39.2","eslint-config-prettier":"^10.1.8","eslint-plugin-prettier":"^5.5.4",globals:"^17.0.0",husky:"^9.1.7",jest:"^30.2.0","lint-staged":"^16.2.7",prettier:"^3.7.4","ts-jest":"^29.4.6",tsup:"^8.5.1",typescript:"^5.9.3","typescript-eslint":"^8.52.0"},pnpm:{overrides:{"test-exclude":"^7.0.1"}}};var C=M.version,Oe=M.name;var w=new q.Command,Y=`
 \u2588\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2557\u2588\u2588\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2588\u2557   \u2588\u2588\u2588\u2557
\u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557\u2588\u2588\u2551\u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2588\u2588\u2551
\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2551\u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2588\u2588\u2554\u255D\u2588\u2588\u2554\u2588\u2588\u2588\u2588\u2554\u2588\u2588\u2551
\u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2551\u2588\u2588\u2551\u2588\u2588\u2554\u2550\u2550\u2550\u255D \u2588\u2588\u2551\u255A\u2588\u2588\u2554\u255D\u2588\u2588\u2551
\u2588\u2588\u2551  \u2588\u2588\u2551\u2588\u2588\u2551\u2588\u2588\u2551     \u2588\u2588\u2551 \u255A\u2550\u255D \u2588\u2588\u2551
\u255A\u2550\u255D  \u255A\u2550\u255D\u255A\u2550\u255D\u255A\u2550\u255D     \u255A\u2550\u255D     \u255A\u2550\u255D
`;w.name("aipm").description("AI-optimized project management system").version(C);w.command("install").description("Install AIPM in current directory").option("-y, --yes","Skip confirmation prompts").option("-p, --preset <name>","Use preset configuration").option("--ai <ais...>","AI tools to use (claude-code, gemini, chatgpt)").option("--guidelines <frameworks...>","Framework guidelines (react, astro)").option("--compact","Use compact version (default)",!0).option("--full","Use full version").action(async e=>{console.log(p.default.blue(Y)),console.log(p.default.blue(`AIPM v${C}
`));try{await P(e)}catch(t){console.error(p.default.red(`
\u274C Error: ${t.message}
`)),process.exit(1)}});w.command("update").description("Update existing installation").option("-f, --force","Overwrite customizations").action(async e=>{console.log(p.default.blue(Y)),console.log(p.default.blue(`AIPM v${C}
`));try{await z(e)}catch(t){console.error(p.default.red(`
\u274C Error: ${t.message}
`)),process.exit(1)}});w.command("diff").description("Show what would change with update").action(async()=>{try{await K()}catch(e){console.error(p.default.red(`
\u274C Error: ${e.message}
`)),process.exit(1)}});w.command("validate").description("Validate current installation").action(async()=>{try{await W()}catch(e){console.error(p.default.red(`
\u274C Error: ${e.message}
`)),process.exit(1)}});w.parse(process.argv);process.argv.slice(2).length||w.outputHelp();
